# Uni-App 双端统一融合计划

## 一、当前状态分析

### 1.1 现有架构对比

| 方面 | 传统 H5 (`src/views/`) | 小程序 (`pages/`) |
|------|------------------------|-------------------|
| 页面入口 | `views/home/index.vue` 等页面 | `pages/index/index.vue` 等页面 |
| 路由管理 | Vue Router (`src/router/index.js`) | uni-app (`src/pages.json`) |
| UI 库 | Vant + Element Plus | uni-app 原生组件 |
| 存储API | `localStorage` | `uni.getStorageSync()` |
| 跳转API | `router.push()` | `uni.navigateTo()` / `uni.switchTab()` |
| 工具目录 | `src/utils/` | `utils/` |
| 导出方式 | `<script setup>` | `<script setup>` |

### 1.2 当前构建配置

项目已配置双构建模式：
- `npm run dev` → 标准 Vite 构建 (H5)
- `npm run dev:mp-weixin` → uni-app 构建 (小程序)

`vite.config.js` 根据 `UNI_PLATFORM` 环境变量切换构建模式。

## 二、融合目标

基于用户需求：
- **融合方式**: 完全 uni-app 化
- **UI 策略**: 迁移到 uni-app 组件
- **实施节奏**: 渐进式
- **H5 部署路径**: 改为根路径 `/` (从 `/order-ease-iui/` 变更)

## 三、融合策略

采用**渐进式迁移方案**，分阶段将现有两套代码合并为一套 uni-app 代码库。

### 核心思路
1. 以 `pages/` 目录为基础（uni-app 标准结构）
2. 合并 `src/utils/` 内容到 `src/utils/`
3. 合并 `utils/` 内容到 `src/utils/`
4. 使用 `store` 替代 `localStorage` (uni-app 兼容)
5. 统一使用 uni-app API
6. 移除 Vue Router，改用 uni-app 路由
7. 移除 Vant/Element Plus，使用 uni-app UI 或 uni-ui

## 四、实施步骤

### 阶段 1: 基础设施调整

#### 1.1 目录结构调整

**新建 `src/store/` 目录** 创建统一存储层

```
src/store/index.js  - 统一存储封装，兼容 H5 和小程序
```

`src/store/index.js` 内容：
```javascript
// 统一存储封装，兼容 localStorage (H5) 和 uni.getStorageSync (小程序)

const isH5 = process.env.UNI_PLATFORM === 'h5'

export const storage = {
  setItem(key, value) {
    const str = typeof value === 'string' ? value : JSON.stringify(value)
    if (isH5) {
      localStorage.setItem(key, str)
    } else {
      uni.setStorageSync(key, value)
    }
  },

  getItem(key) {
    if (isH5) {
      const value = localStorage.getItem(key)
      if (!value) return ''
      try {
        return JSON.parse(value)
      } catch {
        return value
      }
    } else {
      return uni.getStorageSync(key)
    }
  },

  removeItem(key) {
    if (isH5) {
      localStorage.removeItem(key)
    } else {
      uni.removeStorageSync(key)
    }
  },

  clear() {
    if (isH5) {
      localStorage.clear()
    } else {
      uni.clearStorageSync()
    }
  }
}
```

#### 1.2 合并工具文件

**将 `utils/constants.js` 内容合并到 `src/utils/constants.js`**

**更新 `utils/api.js` 导入路径**
- 修改 `import { API_BASE_URL } from '@/utils/constants'` 为 `import { API_BASE_URL } from '../src/utils/constants'`

#### 1.3 API 层统一

修改 `src/api/index.js`，替换 `localStorage` 为统一 `storage`：

```javascript
import axios from 'axios';
import { API_BASE_URL } from '@/utils/constants';
import { storage } from '@/store';
import router from '@/router';  // 后续会移除

const api = axios.create({
  baseURL: API_BASE_URL,
  timeout: 5000
});

api.interceptors.request.use(config => {
  const shop_id = storage.getItem('shop_id');
  const user_id = storage.getItem('user_id');
  const token = storage.getItem('token');

  if (token) {
    config.headers.Authorization = `Bearer ${token}`;
  }

  const isFormData = config.data instanceof FormData;

  if (isFormData) {
    config.params = {...config.params};
    if (shop_id) config.params.shop_id = shop_id;
    if (user_id) config.params.user_id = user_id;
  } else {
    const hasBodyData = config.data && config.data !== '';

    if (hasBodyData) {
      config.data = {...config.data};
      if (shop_id) config.data.shop_id = shop_id;
      if (user_id) config.data.user_id = user_id;
    }
    config.params = {...config.params};
    if (shop_id) config.params.shop_id = shop_id;
    if (user_id) config.params.user_id = user_id;
  }

  return config;
});

api.interceptors.response.use(response => {
  return response;
}, error => {
  // ... 保持原有逻辑
  if (error.response?.status === 401) {
    const isLoginRequest = error.config.url.includes('/user/login');
    if (!isLoginRequest) {
      storage.removeItem('token');
      storage.removeItem('user_info');
      // 这里后续要改为 uni-app 跳转
      router.replace('/login');
    }
  }
  return Promise.reject(error);
});

// 保持所有导出不变
export default api;
```

---

### 阶段 2: 路由统一

#### 2.1 配置 pages.json

保留当前 `src/pages.json`，确保所有页面注册正确：

```json
{
  "pages": [
    {"path": "pages/index/index", "style": {"navigationBarTitleText": "点单系统", "navigationStyle": "custom"}},
    {"path": "pages/orders/orders", "style": {"navigationBarTitleText": "我的订单", "navigationStyle": "custom"}},
    {"path": "pages/mine/mine", "style": {"navigationBarTitleText": "我的", "navigationStyle": "custom"}},
    {"path": "pages/login/login", "style": {"navigationBarTitleText": "登录"}},
    {"path": "pages/register/register", "style": {"navigationBarTitleText": "注册"}},
    {"path": "pages/token-login/token-login", "style": {"navigationBarTitleText": "令牌登录"}}
  ],
  " tabBar": {
    "color": "#7d7e80",
    "selectedColor": "#1989fa",
    "backgroundColor": "#ffffff",
    "borderStyle": "white",
    "list": [
      {"pagePath": "pages/index/index", "text": "首页", "iconPath": "static/tabbar/home.png", "selectedIconPath": "static/tabbar/home-active.png"},
      {"pagePath": "pages/orders/orders", "text": "订单", "iconPath": "static/tabbar/orders.png", "selectedIconPath": "static/tabbar/orders-active.png"},
      {"pagePath": "pages/mine/mine", "text": "我的", "iconPath": "static/tabbar/mine.png", "selectedIconPath": "static/tabbar/mine-active.png"}
    ]
  },
  "globalStyle": {
    "navigationBarTextStyle": "black",
    "navigationBarTitleText": "点单系统",
    "navigationBarBackgroundColor": "#ffffff",
    "backgroundColor": "#f7f8fa"
  }
}
```

#### 2.2 移除 Vue Router

1. 删除 `src/router/index.js`
2. 删除 `src/App.vue` 中的 `router-view`
3. 更新 `src/main.js`

`src/main.js` 改为：
```javascript
import { createSSRApp } from 'vue'

export function createApp() {
  const app = createSSRApp(App)
  return {
    app
  }
}
```

**注意**: uni-app 要求 `createApp` 函数的默认导出，确保正确配置。

---

### 阶段 3: 页面迁移

#### 3.1 合并 `pages/mine/mine.vue`

从 `src/views/Mine.vue` 迁移逻辑到 `pages/mine/mine.vue`，主要变更：
- 将 `localStorage` 替换为 `storage`
- 将 `router.push` 替换为 `uni.navigateTo`
- 将 Vant 组件替换为 uni-app 原生组件

#### 3.2 迁移其他页面

按需迁移：
- `pages/register/register.vue` - 对齐 `src/views/Register.vue`
- `pages/token-login/token-login.vue` - 对齐 `src/views/TokenLogin.vue`

---

### 阶段 4: 组件迁移

#### 4.1 组件目录统一

将以下组件从 `src/components/` 复制到 `src/components/`，并适配 uni-app：
- `CommonNavBar.vue` - 替换为 `<uni-nav-bar>` 或自定义封装
- `CategoryList.vue` - 保持逻辑，修改 `<div>` 为 `<view>`
- `ProductList.vue` - 保持逻辑，适配 uni-app
- `ShoppingCart.vue` - 保持逻辑，修改 Vant 组件为原生
- `ProductCard.vue` - 保持逻辑
- `ProductDetailPopup.vue` - 可能需要创建

#### 4.2 Vant 组件替换对照

| Vant | uni-app (或 uni-ui) |
|------|---------------------|
| `<van-popup>` | `<uni-popup>` |
| `<van-stepper>` | `<uni-number-box>` |
| `<van-button>` | `<button>` (native) 或 `<uni-button>` |
| `<van-field>` | `<uni-easyinput>` |
| `<van-image>` | `<image>` (native) |
| `<van-toast>` | `uni.showToast()` |
| `<van-tabbar>` | `pages.json` 中的 `tabBar` 配置 |
| `<van-nav-bar>` | `<uni-nav-bar>` |

---

### 阶段 5: 样式和配置调整

#### 5.1 更新 vite.config.js

移除 base path，改为根路径：

```javascript
import { fileURLToPath, URL } from 'node:url'
import { defineConfig } from 'vite'
import vue from '@vitejs/plugin-vue'
import path from 'path'
import { createRequire } from 'module'

const require = createRequire(import.meta.url)
const isUni = process.env.UNI_PLATFORM !== undefined

export default defineConfig(async () => {
  if (isUni) {
    const uni = require('@dcloudio/vite-plugin-uni')
    const plugins = typeof uni.default === 'function' ? uni.default() : (typeof uni === 'function' ? uni() : [])
    return {
      plugins: Array.isArray(plugins) ? plugins : [plugins],
      resolve: {
        alias: {
          '@': path.resolve(__dirname, 'src')
        }
      },
      server: {
        host: "0.0.0.0",
        port: "3001",
        proxy: {
          '/api': {
            target: 'http://localhost:8080',
            changeOrigin: true,
            rewrite: (path) => path.replace(/^\/api/, '')
          }
        }
      }
    }
  }

  // H5 build configuration - 移除 base path
  return {
    base: '/',  // 从 '/order-ease-iui/' 改为 '/'
    plugins: [vue()],
    resolve: {
      alias: {
        '@': path.resolve(__dirname, 'src')
      }
    },
    build: {
      outDir: 'dist/h5',
      emptyOutDir: true
    },
    server: {
      host: "0.0.0.0",
      port: "3001",
      proxy: {
        '/api': {
          target: 'http://localhost:8080',
          changeOrigin: true,
          rewrite: (path) => path.replace(/^\/api/, '')
        }
      }
    }
  }
})
```

#### 5.2 更新 manifest.json

配置 H5 的基本 path：

```json
{
  "h5": {
    "base": "/",
    "router": {
      "mode": "history",
      "base": "/"
    }
  },
  // ... 其他配置保持不变
}
```

---

### 阶段 6: 清理和验证

#### 6.1 删除冗余文件

```
删除以下目录/文件：
├── src/views/          - 整个目录（迁移到 pages/ 后）
├── src/router/         - 整个目录
├── utils/              - 合并到 src/utils/
```

#### 6.2 更新 package.json

确认脚本不变：
```json
{
  "scripts": {
    "dev": "vite",
    "dev:mp-weixin": "uni",
    "build": "vite build",
    "build:mp-weixin": "uni build",
    "build:prod": "vite build --mode production",
    "preview": "vite preview"
  }
}
```

#### 6.3 更新 CLAUDE.md

更新项目文档，反映新的架构。

---

## 五、关键文件清单

### 需要创建的文件

| 文件 | 说明 |
|------|------|
| `src/store/index.js` | 统一存储封装 |
| `utils/image.js` | 图标工具（需要迁移到 src/utils/） |
| `utils/api.js` | API 工具（已存在，需要更新导入路径） |

### 需要修改的文件

| 文件 | 修改内容 |
|------|----------|
| `src/api/index.js` | 使用 storage 替代 localStorage |
| `src/main.js` | 移除 Vue Router，适配 uni-app |
| `vite.config.js` | base 改为 `/` |
| `src/manifest.json` | H5 配置添加 base |
| `pages/**/*.vue` | 统一使用 Storage API 和 uni-app API |

### 需要删除的文件

| 文件 | 原因 |
|------|------|
| `src/router/index.js` | uni-app 不需要 |
| `src/views/*` | 合并到 pages/ |
| `utils/` | 合并到 src/utils/ |

---

## 六、验证步骤

### 6.1 验证 H5 构建

```bash
npm run dev
```

检查：
1. 访问 `http://localhost:3001/` 能否正常打开
2. 页面跳转是否正常
3. 存储功能是否工作
4. API 调用是否成功

### 6.2 验证小程序构建

```bash
npm run dev:mp-weixin
```

使用微信开发者工具打开 `dist/dev/mp-weixin` 目录：
1. 页面是否正常渲染
2. tabBar 是否显示
3. 登录流程是否正常
4. 订单提交是否成功

### 6.3 构建测试

```bash
# H5 生产构建
npm run build:prod

# 小程序生产构建
npm run build:mp-weixin
```

---

## 七、风险与注意事项

### 7.1 兼容性风险

| 风险 | 缓解措施 |
|------|----------|
| localStorage 不兼容小程序 | 使用统一 storage 封装 |
| Vant 组件无法在小程序运行 | 逐步替换为 uni-app 组件 |
| H5 旧链接失效 | 通过服务器重定向处理 |
| 样式单位 rpx 在网页显示异常 | 使用 uni-app 内置的 rpx 转 px |

### 7.2 迁移要点

1. **条件编译**: 如需保留 H5 特定功能，可使用 `// #ifdef H5`
2. **样式适配**: `rpx` 在 H5 中需要转换，uni-app 会自动处理
3. **API 差异**: 所有 DOM 操作需要改为 uni-app 兼容方式

---

## 八、时间估算

| 阶段 | 预计工作量 |
|------|-----------|
| 阶段 1: 基础设施 | 1-2 小时 |
| 阶段 2: 路由统一 | 2-3 小时 |
| 阶段 3: 页面迁移 | 4-6 小时 |
| 阶段 4: 组件迁移 | 4-6 小时 |
| 阶段 5: 样式配置 | 1-2 小时 |
| 阶段 6: 清理验证 | 2-3 小时 |
| **总计** | **14-22 小时** |

---

## 九、后续优化方向

1. 引入 **Pinia** 替代全局存储
2. 使用 **uView UI** 或 **uni-ui** 统一组件库
3. 添加 **TypeScript** 支持
4. 配置 **CI/CD** 自动化构建